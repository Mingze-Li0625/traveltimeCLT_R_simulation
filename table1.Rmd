---
title: "Table 1"
author: "Mingze Li"
date: "2015-06-11"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(traveltimeCLT)
library(data.table)
```
```{r}
trips <- fread("data/trips.csv")
trips$timeBin <- time_bins_readable(trips$time)
timebin <- c("Global", unique(trips$timeBin))
```

```{r}
trips[, duration := as.numeric(difftime(shift(time, type = "lead"), time, units = "secs")), by = trip]
trips[, log_duration := log(duration)]

set.seed(12345)
id1 <- sample(unique(trips$trip), 1000)
id2 <- sample(unique(trips$trip), 4000)
trips1 <- trips[trips$trip %in% id1, ]
trips2 <- trips[trips$trip %in% id2, ]
stats <- trips1[, .(
    mean = mean(duration, na.rm = TRUE),
    sd = sd_one_input_is_0(duration),
    frequency = .N
),
by = .(timeBin)
]
stats <- rbind(stats, list(
    timeBin = "Global",
    mean = mean(trips1$duration, na.rm = TRUE),
    sd = sd_one_input_is_0(trips1$duration),
    frequency = nrow(trips1)
))
stats
```

```{r}
residual <- trips2[, .(
    residual = duration - mean(duration, na.rm = TRUE),
    standard_residual = (duration - mean(duration, na.rm = TRUE)) / sd_one_input_is_0(duration),
    global_residual = duration - stats[timeBin == "Global"]$mean,
    global_standard_residual = (duration - stats[timeBin == "Global"]$mean) / stats[timeBin == "Global"]$log_sd
), by = timeBin]
residual <- residual[, `:=`(
    next_standard_residual = shift(standard_residual, type = "lead"),
    next_global_standard = shift(global_standard_residual, type = "lead")
), by = timeBin]
stats2 <- residual[,
    .(
        correlation = cor(standard_residual, next_standard_residual, use = "complete.obs"),
        mean_residual = mean(residual, na.rm = TRUE),
        sd_residual = sd_one_input_is_0(residual),
        frequency = .N
    ),
    by = timeBin
]
stats2 <- rbind(stats2, list(
    timeBin = "Global",
    correlation = cor(residual$standard_residual, residual$next_standard_residual, use = "complete.obs"),
    mean_residual = mean(residual$residual, na.rm = TRUE),
    sd_residual = sd_one_input_is_0(residual$residual),
    frequency = nrow(residual)
))
stats2
```